<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­æ°´æº–è§€æ¸¬è¨˜éŒ„è¡¨</title>
    <style>
        :root {
            --primary-bg: #ffffff;
            --header-bg: #f8f9fa;
            --border-color: #000000;
            --input-focus: #e3f2fd;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f0f0;
        }

        .container {
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h2 { text-align: center; font-size: 1.2rem; margin-top: 0; }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px; /* ç¢ºä¿æ¬„ä½ä¸æ“ å£“ */
            background: white;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 4px;
            text-align: center;
            font-size: 14px;
        }

        th { background-color: var(--header-bg); }

        /* æ¨™é¡Œåˆ—å¯¬åº¦èª¿æ•´ */
        .col-id { width: 60px; }
        .col-val { width: 80px; }
        .col-dist { width: 80px; }
        .col-elev { width: 90px; }
        .col-note { width: 100px; }

        input {
            width: 95%;
            border: none;
            text-align: center;
            font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
            padding: 8px 0;
            background: transparent;
        }

        input:focus { background-color: var(--input-focus); outline: none; }

        /* å”¯è®€æ¬„ä½é¡è‰² */
        .readonly { background-color: #f9f9f9; color: #d32f2f; font-weight: bold; }
        .initial-bg { background-color: #00a2e8; color: white; } /* åœ–ç‰‡ä¸­çš„è—è‰²é«˜ç¨‹ */
        .first-row-bg { background-color: #fff200; } /* åœ–ç‰‡ä¸­çš„é»ƒè‰² */

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            padding: 12px;
            border: 1px solid #333;
            background: #fff;
            font-weight: bold;
            cursor: pointer;
            min-width: 120px;
        }

        button:active { background: #eee; }
        .btn-save { background: #27ae60; color: white; border: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>æ°´æº–è§€æ¸¬è¨ˆç®—è¡¨</h2>

    <div class="table-wrapper">
        <table id="surveyTable">
            <thead>
                <tr>
                    <th rowspan="2" class="col-id">é»è™Ÿ</th>
                    <th colspan="2">æ¨™å°ºè®€æ•¸</th>
                    <th rowspan="2" class="col-elev">é«˜ç¨‹</th>
                    <th colspan="2">è·é›¢</th>
                    <th rowspan="2" class="col-val">æ”¹æ­£æ•¸</th>
                    <th rowspan="2" class="col-elev">é«˜ç¨‹ (æ”¹æ­£å¾Œ)</th>
                    <th rowspan="2" class="col-note">å‚™è¨»</th>
                </tr>
                <tr>
                    <th>å¾Œè¦–(BS)</th>
                    <th>å‰è¦–(FS)</th>
                    <th>å¾Œè¦–</th>
                    <th>å‰è¦–</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="first-row-bg"><input type="text" value="B20"></td>
                    <td><input type="number" step="0.001" class="bs-val" oninput="calculate()"></td>
                    <td><input type="number" step="0.001" class="fs-val" oninput="calculate()"></td>
                    <td class="initial-bg"><input type="number" step="0.001" class="elev-pre" value="31.961" oninput="calculate()"></td>
                    <td><input type="number" step="0.01" class="bs-dist"></td>
                    <td><input type="number" step="0.01" class="fs-dist"></td>
                    <td><input type="number" step="0.0001" class="correction" oninput="calculate()"></td>
                    <td class="first-row-bg"><input type="number" step="0.001" class="elev-final readonly" readonly></td>
                    <td><input type="text"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="controls">
        <button onclick="addRow()">â• æ–°å¢è§€æ¸¬é»</button>
        <button class="btn-save" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º CSV æª”</button>
        <button onclick="if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) location.reload()">ğŸ—‘ï¸ é‡ç½®è¡¨å–®</button>
    </div>
    
    <p style="font-size: 12px; color: #666;">* æç¤ºï¼šæ‰‹æ©Ÿæ©«å±çœ‹æ›´æ¸…æ™°ã€‚é«˜ç¨‹(æ”¹æ­£å¾Œ) = é«˜ç¨‹ + æ”¹æ­£æ•¸ã€‚</p>
</div>

<script>
    function addRow() {
        const table = document.querySelector("#surveyTable tbody");
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="text"></td>
            <td><input type="number" step="0.001" class="bs-val" oninput="calculate()"></td>
            <td><input type="number" step="0.001" class="fs-val" oninput="calculate()"></td>
            <td><input type="number" step="0.001" class="elev-pre readonly" readonly></td>
            <td><input type="number" step="0.01" class="bs-dist"></td>
            <td><input type="number" step="0.01" class="fs-dist"></td>
            <td><input type="number" step="0.0001" class="correction" oninput="calculate()"></td>
            <td><input type="number" step="0.001" class="elev-final readonly" readonly></td>
            <td><input type="text"></td>
        `;
        table.appendChild(row);
    }

    function calculate() {
        const rows = document.querySelectorAll("#surveyTable tbody tr");
        let currentHI = 0;

        rows.forEach((row, index) => {
            const bs = parseFloat(row.querySelector(".bs-val").value) || 0;
            const fs = parseFloat(row.querySelector(".fs-val").value) || 0;
            const corr = parseFloat(row.querySelector(".correction").value) || 0;
            const elevPreInput = row.querySelector(".elev-pre");
            const elevFinalInput = row.querySelector(".elev-final");

            if (index === 0) {
                // åŸºæº–é»
                let baseElev = parseFloat(elevPreInput.value) || 0;
                elevFinalInput.value = (baseElev + corr).toFixed(3);
                if (bs !== 0) currentHI = baseElev + bs;
            } else {
                // è§€æ¸¬é»
                if (currentHI !== 0) {
                    let preElev = currentHI - fs;
                    elevPreInput.value = preElev.toFixed(3);
                    elevFinalInput.value = (preElev + corr).toFixed(3);
                    
                    // å¦‚æœé€™é»æœ‰å¾Œè¦–ï¼Œæ›´æ–°å™¨é«˜çµ¦ä¸‹ä¸€é»ç”¨
                    if (bs !== 0) {
                        currentHI = preElev + bs;
                    }
                }
            }
        });
    }

    function exportCSV() {
        let csv = "\uFEFFé»è™Ÿ,å¾Œè¦–(BS),å‰è¦–(FS),é«˜ç¨‹,å¾Œè¦–è·é›¢,å‰è¦–è·é›¢,æ”¹æ­£æ•¸,é«˜ç¨‹(æ”¹æ­£å¾Œ),å‚™è¨»\n";
        document.querySelectorAll("#surveyTable tbody tr").forEach(row => {
            const data = Array.from(row.querySelectorAll("input")).map(i => i.value);
            csv += data.join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `æ°´æº–è§€æ¸¬ç´€éŒ„_${new Date().getTime()}.csv`;
        link.click();
    }
</script>

</body>
</html>