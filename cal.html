<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>污水管線縱斷面計算機 (重力流)</title>
    <style>
        :root {
            --bg-color: #1e293b;
            --panel-color: #334155;
            --input-bg: #0f172a;
            --text-color: #e2e8f0;
            --accent-blue: #38bdf8;
            --accent-green: #4ade80;
            --accent-orange: #fb923c;
            --accent-red: #f87171;
            --border-color: #475569;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-blue);
            padding-bottom: 10px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        /* 繪圖區域 */
        .visualization-box {
            background-color: #fff; /* 圖紙背景白 */
            border-radius: 8px;
            padding: 10px;
            height: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* 輸入控制區域 */
        .control-panel {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 15px;
            background-color: var(--panel-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .panel-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
        }

        .panel-section.upstream { border-top: 4px solid var(--accent-blue); }
        .panel-section.pipe { border-top: 4px solid var(--accent-orange); }
        .panel-section.downstream { border-top: 4px solid var(--accent-green); }

        h3 {
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .input-group label {
            font-size: 0.9em;
            color: #94a3b8;
            flex: 1;
        }

        .input-wrapper {
            flex: 2;
            position: relative;
        }

        input[type="number"] {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 1em;
            text-align: right;
            box-sizing: border-box;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        /* 自動計算出的數值樣式 */
        input.auto-filled {
            color: var(--accent-green);
            font-weight: bold;
            border-color: var(--accent-green);
        }

        .unit {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 0.8em;
            pointer-events: none;
        }

        .btn-area {
            grid-column: 1 / -1;
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
        }

        button {
            padding: 10px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }

        .btn-calc { background-color: var(--accent-blue); color: #0f172a; }
        .btn-reset { background-color: var(--border-color); color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }

        /* 警告訊息 */
        .status-msg {
            grid-column: 1 / -1;
            text-align: center;
            min-height: 24px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .error { color: var(--accent-red); }
        .info { color: var(--accent-green); }

        @media (max-width: 768px) {
            .control-panel { grid-template-columns: 1fr; }
            .panel-section.pipe { order: 2; }
            .panel-section.upstream { order: 1; }
            .panel-section.downstream { order: 3; }
        }

        /* SVG Styles */
        .svg-ground { stroke: #64748b; stroke-width: 2; stroke-dasharray: 5,5; }
        .svg-manhole { fill: #e2e8f0; stroke: #334155; stroke-width: 2; }
        .svg-pipe { stroke: #f97316; stroke-width: 4; }
        .svg-water { stroke: #38bdf8; stroke-width: 2; stroke-dasharray: 2,2; }
        .svg-text { font-size: 12px; fill: #334155; font-family: monospace; }
        .svg-dim { stroke: #94a3b8; stroke-width: 1; }
        .highlight-bg { fill: #fef3c7; } /* 標示坡度異常 */
    </style>
</head>
<body>

    <h1>污水管線縱斷面計算機</h1>

    <div class="container">
        <!-- 圖形顯示區 -->
        <div class="visualization-box" id="visBox">
            <svg id="mainSvg" viewBox="0 0 800 400" preserveAspectRatio="xMidYMid meet">
                <!-- 內容將由 JS 動態生成 -->
                <text x="400" y="200" text-anchor="middle" fill="#94a3b8">請輸入數據並點擊計算</text>
            </svg>
        </div>

        <div class="status-msg" id="statusMsg"></div>

        <!-- 控制面板 -->
        <div class="control-panel">
            
            <!-- 下游 (左側) -->
            <div class="panel-section downstream">
                <h3>下游人孔 (左/Out)</h3>
                <div class="input-group">
                    <label>地面 (GL)</label>
                    <div class="input-wrapper">
                        <input type="number" id="gl_down" placeholder="選填" step="0.01">
                        <span class="unit">m</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>管底 (INV)</label>
                    <div class="input-wrapper">
                        <input type="number" id="inv_down" placeholder="高程" step="0.01">
                        <span class="unit">m</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>深度 (D)</label>
                    <div class="input-wrapper">
                        <input type="number" id="depth_down" placeholder="GL-INV" step="0.01" readonly style="background:rgba(0,0,0,0.3); cursor:default;">
                        <span class="unit">m</span>
                    </div>
                </div>
            </div>

            <!-- 管線參數 (中間) -->
            <div class="panel-section pipe">
                <h3>管線參數 (Pipe)</h3>
                <div class="input-group">
                    <label>長度 (L)</label>
                    <div class="input-wrapper">
                        <input type="number" id="length" placeholder="距離" step="0.01">
                        <span class="unit">m</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>坡度 (S)</label>
                    <div class="input-wrapper">
                        <input type="number" id="slope" placeholder="百分比" step="0.01">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>落差 (Fall)</label>
                    <div class="input-wrapper">
                        <input type="number" id="fall" placeholder="高程差" step="0.01" readonly style="background:rgba(0,0,0,0.3); cursor:default;">
                        <span class="unit">m</span>
                    </div>
                </div>
            </div>

            <!-- 上游 (右側) -->
            <div class="panel-section upstream">
                <h3>上游人孔 (右/In)</h3>
                <div class="input-group">
                    <label>地面 (GL)</label>
                    <div class="input-wrapper">
                        <input type="number" id="gl_up" placeholder="選填" step="0.01">
                        <span class="unit">m</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>管底 (INV)</label>
                    <div class="input-wrapper">
                        <input type="number" id="inv_up" placeholder="高程" step="0.01">
                        <span class="unit">m</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>深度 (D)</label>
                    <div class="input-wrapper">
                        <input type="number" id="depth_up" placeholder="GL-INV" step="0.01" readonly style="background:rgba(0,0,0,0.3); cursor:default;">
                        <span class="unit">m</span>
                    </div>
                </div>
            </div>

            <div class="btn-area">
                <button class="btn-calc" onclick="calculateAll()">計算並繪圖 (Calculate)</button>
                <button class="btn-reset" onclick="resetAll()">清除重設 (Reset)</button>
            </div>
        </div>
    </div>

    <script>
        // 取得所有輸入框 DOM
        const els = {
            gl_down: document.getElementById('gl_down'),
            inv_down: document.getElementById('inv_down'),
            depth_down: document.getElementById('depth_down'),
            
            length: document.getElementById('length'),
            slope: document.getElementById('slope'),
            fall: document.getElementById('fall'),

            gl_up: document.getElementById('gl_up'),
            inv_up: document.getElementById('inv_up'),
            depth_up: document.getElementById('depth_up'),

            svg: document.getElementById('mainSvg'),
            msg: document.getElementById('statusMsg')
        };

        // 取得數值 (Helper function)
        const val = (id) => {
            const v = parseFloat(els[id].value);
            return isNaN(v) ? null : v;
        };

        // 設定數值並標記樣式
        const setVal = (id, v, isAuto = true) => {
            const el = els[id];
            el.value = v.toFixed(3); // 工程通常取小數點後三位
            if (isAuto) {
                el.classList.add('auto-filled');
                setTimeout(() => el.classList.remove('auto-filled'), 2000); // 閃爍效果
            }
        };

        // 清除樣式監聽
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => input.classList.remove('auto-filled'));
        });

        function resetAll() {
            document.querySelectorAll('input').forEach(i => i.value = '');
            els.svg.innerHTML = '<text x="400" y="200" text-anchor="middle" fill="#94a3b8">請輸入數據並點擊計算</text>';
            els.msg.textContent = '';
        }

        // 核心計算邏輯
        function calculateAll() {
            els.msg.textContent = '';
            els.msg.className = 'status-msg';

            // 1. 處理地面高程 (GL) 邏輯
            // 規則：如果都沒填，暫時不處理（繪圖時給假定值）。如果填了一個，另一個預設相等。
            let gUp = val('gl_up');
            let gDown = val('gl_down');
            
            if (gUp !== null && gDown === null) {
                gDown = gUp;
                setVal('gl_down', gDown);
            } else if (gDown !== null && gUp === null) {
                gUp = gDown;
                setVal('gl_up', gUp);
            }

            // 2. 處理管線幾何計算 (知三求一)
            // 變數：inv_up, inv_down, length, slope
            let iUp = val('inv_up');
            let iDown = val('inv_down');
            let L = val('length');
            let S = val('slope');

            // 邏輯判斷迴圈 (簡單的一次性判斷)
            try {
                // 情況 A: 已知兩端高程 -> 算 Fall
                if (iUp !== null && iDown !== null) {
                    const fall = iUp - iDown;
                    setVal('fall', fall);
                    
                    // 如果有長度，算坡度
                    if (L !== null && S === null) {
                        if (L <= 0) throw "管線長度必須大於 0";
                        S = (fall / L) * 100;
                        setVal('slope', S);
                    } 
                    // 如果有坡度，算長度 (較少見，但可算)
                    else if (S !== null && L === null) {
                        if (S === 0) throw "坡度為 0 無法反推長度";
                        L = (fall / (S/100));
                        setVal('length', L);
                    }
                }
                // 情況 B: 已知上游 + 長度 + 坡度 -> 算下游
                else if (iUp !== null && L !== null && S !== null && iDown === null) {
                    const fall = L * (S / 100);
                    iDown = iUp - fall;
                    setVal('inv_down', iDown);
                    setVal('fall', fall);
                }
                // 情況 C: 已知下游 + 長度 + 坡度 -> 算上游
                else if (iDown !== null && L !== null && S !== null && iUp === null) {
                    const fall = L * (S / 100);
                    iUp = iDown + fall;
                    setVal('inv_up', iUp);
                    setVal('fall', fall);
                }
            } catch (e) {
                els.msg.textContent = "錯誤: " + e;
                els.msg.classList.add('error');
                return;
            }

            // 重新抓取計算後的值
            iUp = val('inv_up');
            iDown = val('inv_down');
            gUp = val('gl_up');
            gDown = val('gl_down');

            // 3. 計算深度 (Depth)
            if (iUp !== null && gUp !== null) setVal('depth_up', gUp - iUp, false);
            if (iDown !== null && gDown !== null) setVal('depth_down', gDown - iDown, false);

            // 4. 驗證與警告
            if (iUp !== null && iDown !== null && iUp < iDown) {
                els.msg.innerHTML = "⚠️ 警告：發生逆坡 (上游高程低於下游)，請檢查數據！";
                els.msg.classList.add('error');
            } else if (S !== null && S < 0.3) {
                els.msg.innerHTML = "ℹ️ 提示：坡度小於 0.3%，流速可能不足。";
                els.msg.classList.add('info');
            }

            // 5. 執行繪圖
            drawSVG(gUp, gDown, iUp, iDown, L, S);
        }

        // SVG 繪圖邏輯
        function drawSVG(gUp, gDown, iUp, iDown, L, S) {
            if (iUp === null || iDown === null) return;

            // 如果沒有 GL，為了繪圖美觀，假定 GL = 最高 INV + 2m
            const maxInv = Math.max(iUp, iDown);
            let drawGUp = gUp !== null ? gUp : maxInv + 2.5;
            let drawGDown = gDown !== null ? gDown : maxInv + 2.5;

            // 1. 定義畫布邊界與座標系
            const w = 800;
            const h = 400;
            const padding = 60;
            const chartW = w - padding * 2;
            const chartH = h - padding * 2;

            // 2. 計算 Y 軸縮放比例 (Vertical Scale)
            // 找出最大與最小高程 (包含 INV 和 GL)
            const maxEl = Math.max(drawGUp, drawGDown);
            const minEl = Math.min(iUp, iDown);
            let diffEl = maxEl - minEl;
            if (diffEl < 1) diffEl = 1; // 避免高程差太小導致爆掉

            // 每公尺代表多少像素 (保留上下緩衝)
            const scaleY = chartH / (diffEl * 1.2); 
            
            // Y軸轉換函數 (高程 -> 像素 Y)
            // SVG Y軸向下是正，所以要反轉：PixelY = Padding + (MaxEl - TargetEl) * scale
            const getY = (el) => padding + (maxEl - el) * scaleY + (padding * 0.5); // 稍微往下移一點

            // X軸位置 (固定)
            const xDown = padding + 50;      // 左側人孔中心 (下游)
            const xUp = w - padding - 50;    // 右側人孔中心 (上游)
            const mhWidth = 60;              // 人孔寬度

            // 座標計算
            const yGDown = getY(drawGDown);
            const yGUp = getY(drawGUp);
            const yIDown = getY(iDown);
            const yIUp = getY(iUp);

            // 顏色定義
            const isBackPitch = iUp < iDown;
            const pipeColor = isBackPitch ? '#ef4444' : '#f97316'; // 逆坡變紅

            // 構建 SVG 內容
            let svgContent = ``;

            // 背景網格 (選用)
            svgContent += `<defs>
                <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f1f5f9" stroke-width="1"/>
                </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#grid)" />`;

            // --- 繪製 GL (地面線) ---
            svgContent += `<line x1="${xDown-50}" y1="${yGDown}" x2="${xUp+50}" y2="${yGUp}" class="svg-ground" />`;
            svgContent += `<text x="${xDown-40}" y="${yGDown-10}" class="svg-text" fill="#64748b">GL:${drawGDown.toFixed(2)}</text>`;
            svgContent += `<text x="${xUp+10}" y="${yGU
